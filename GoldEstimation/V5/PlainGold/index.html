<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gold Price Estimator</title>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #2e0066, #4b0082, #6a0dad);
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 30px 16px;
    }

    .background-gradient {
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 30%, rgba(255, 215, 0, 0.12), transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(255, 165, 0, 0.12), transparent 50%);
      pointer-events: none;
    }

    .content {
      max-width: 1100px;
      width: 100%;
      z-index: 1;
    }

    .header {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      gap: 40px;
      margin-bottom: 30px;
      text-align: left;
    }

    .rate-display {
      background: linear-gradient(90deg, rgba(255,215,0,0.12), rgba(255,165,0,0.08));
      padding: 12px 18px;
      border-radius: 12px;
      border: 1px solid rgba(255,215,0,0.18);
      color: #ffd700;
      min-width: 200px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .rate-display .rate-label {
      display: block;
      font-size: 1.15rem;
      color: rgba(255,215,0,0.98);
      font-weight: 800;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    #rateBig {
      display: block;
      margin-top: 6px;
      font-size: 2.4rem;
      font-weight: 900;
      color: #fff3c6;
    }

    .rings-image {
      width: 110px;
      height: 110px;
      border-radius: 50%;
      border: 5px solid #ffd700;
      object-fit: cover;
      margin-bottom: 14px;
    }

    .title {
      font-size: 2.5rem;
      background: linear-gradient(90deg, #ffd700, #ffec8b, #ffd700);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      margin-top: 6px;
      opacity: 0.9;
    }

    .card {
      background: rgba(30, 10, 70, 0.45);
      backdrop-filter: blur(14px);
      border-radius: 24px;
      padding: 24px;
      border: 1px solid rgba(255, 215, 0, 0.18);
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 20px;
    }

    .input-field label {
      display: block;
      margin-bottom: 6px;
    }

    input,
    select {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 1rem;
      outline: none;
    }

    .result {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 18px;
      padding: 22px;
      border: 1px solid rgba(255, 215, 0, 0.2);
    }

    .result-header {
      text-align: center;
      color: #ffd700;
      font-weight: bold;
      margin-bottom: 16px;
      font-size: 1.2rem;
    }

    .result-row,
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
    }

    .total-row {
      border-top: 2px solid rgba(255, 215, 0, 0.3);
      font-size: 1.3rem;
      font-weight: bold;
      color: #ffd700;
    }

    @media (max-width: 768px) {
      .card {
        grid-template-columns: 1fr;
      }

      .input-row {
        grid-template-columns: 1fr;
      }
      .header {
        flex-direction: column;
        text-align: center;
      }
    }

    select option {
      background: #2e0066;
      color: white;
    }
  </style>
</head>

<body>

  <div class="background-gradient"></div>

  <div class="content">

    <div class="header">
      <div>
        <h1 class="title">ü™ô Gold Price Calculation</h1>
        <p class="subtitle">Instant gold value estimation (rate is live)</p>
      </div>

      <div class="rate-display" id="rateDisplay">
        <span class="rate-label">RATE FOR GRAM</span>
        <span id="rateBig">‚Çπ6000</span>
      </div>
    </div>

    <div class="card">

      <!-- INPUTS -->
      <div>
        <div class="input-row">
          <div class="input-field">
            <label>Weight (grams)</label>
            <input type="number" id="weight" value="10">
          </div>

          <div class="input-field">
            <label>Purity</label>
            <select id="purity">
              <option value="0.916">22K (91.6%)</option>
              <option value="0.75">18K (75%)</option>
              <option value="0.585">14K (58.5%)</option>
              <option value="1">24K (100%)</option>
            </select>
          </div>
        </div>

        <div class="input-row">
          <div class="input-field">
            <label>Rate per Gram (‚Çπ)</label>
            <input type="number" id="rate" value="6000">
          </div>

          <div class="input-field">
            <label>Making Charges (%)</label>
            <input type="number" id="making" value="10">
          </div>
        </div>
      </div>

      <!-- RESULT -->
      <div class="result">
        <div class="result-header"> Estimation Result </div>

        <div class="result-row">
          <span>ü™ô Base Price</span>
          <span id="basePrice">‚Çπ0</span>
        </div>

        <div class="result-row">
          <span>‚öôÔ∏è Making Charges</span>
          <span id="makingPrice">‚Çπ0</span>
        </div>

        <div class="result-row">
          <span>üßæ GST (3%)</span>
          <span id="gstPrice">‚Çπ0</span>
        </div>

        <div class="total-row">
          <span>Total</span>
          <span id="totalPrice">‚Çπ0</span>
        </div>
      </div>

    </div>
  </div>

  <!-- JAVASCRIPT -->
  <script src="./Js/Index/calculateGoldPrice.js" type="module"></script>
  <script type="module">
    import { calculateAllPricesWithAdjustedRate } from "./Js/Index/calculateGoldPrice.js";

    // ============= PRICE CALCULATION LOGIC =============
    // Base Price = Weight (grams) √ó Rate (per gram, adjusted for purity)
    // Making Charges = Base Price √ó (Making % / 100)
    // GST = (Base Price + Making Charges) √ó 3%
    // Total = Base Price + Making Charges + GST
    // ===================================================

    // DOM Elements
    const weightInput = document.getElementById("weight");
    const purityEl = document.getElementById("purity");
    const rateInput = document.getElementById("rate");
    const makingInput = document.getElementById("making");
    let basePrice24 = 6000; // Initialize with default, will be updated by live rate
    let isUpdatingRate = false; // Flag to prevent circular updates

    function calculateGold() {
      const weight = +weightInput.value || 0;
      const rate = +rateInput.value || 0;
      const making = +makingInput.value || 0;

      // Use the calculation module (rate is already purity-adjusted)
      const result = calculateAllPricesWithAdjustedRate(weight, rate, making);

      // Update UI with results
      document.getElementById("basePrice").innerText = "‚Çπ" + result.basePrice;
      document.getElementById("makingPrice").innerText = "‚Çπ" + result.makingCharges;
      document.getElementById("gstPrice").innerText = "‚Çπ" + result.gst;
      document.getElementById("totalPrice").innerText = "‚Çπ" + result.totalPrice;

      const rateBigEl = document.getElementById("rateBig");
      if (rateBigEl) rateBigEl.innerText = "‚Çπ" + Math.round(rate);
    }

    function updateRateForPurity() {
      const purity = +purityEl.value || 1;
      const newRate = Math.round(basePrice24 * purity);
      
      // Set flag to prevent input listener from triggering unwanted events
      isUpdatingRate = true;
      rateInput.value = newRate;
      isUpdatingRate = false;
      
      calculateGold();
    }

    // Event listeners
    weightInput.addEventListener("input", calculateGold);
    makingInput.addEventListener("input", calculateGold);
    rateInput.addEventListener("input", calculateGold);
    
    // When purity changes, try to get the freshest live 24K rate then update the displayed rate
    async function handlePuritySelection() {
      // Try a quick live fetch; if it succeeds, update basePrice24
      try {
        const fresh = await fetchLiveRateOnce();
        if (fresh) basePrice24 = fresh;
      } catch (e) {
        // ignore fetch errors ‚Äî we'll fall back to last known basePrice24
      }
      updateRateForPurity();
    }

    purityEl.addEventListener("input", handlePuritySelection);
    purityEl.addEventListener("change", handlePuritySelection);

    // --- Live rate fetching configuration (optional) ---
    const LIVE_RATE_URL = 'https://data-asg.goldprice.org/dbXRates/INR';
    const RATE_FETCH_INTERVAL_MS = 60 * 1000; // 1 minute

    async function fetchLiveRateOnce() {
      if (!LIVE_RATE_URL) return null;
      try {
        const res = await fetch(LIVE_RATE_URL, { 
          cache: 'no-store',
          mode: 'cors',
          headers: {
            'Accept': 'application/json'
          }
        });
        if (!res.ok) throw new Error('API returned status: ' + res.status);
        const data = await res.json();

        let pricePerGram = null;
        if (data && data.items && data.items.length) {
          const item = data.items[0];
          if (item.gpPrice) pricePerGram = +item.gpPrice;
          else if (item.gpPrice16) pricePerGram = +item.gpPrice16;
          else if (item.xauPrice) pricePerGram = (+item.xauPrice) / 31.1034768;
        }

        if (!pricePerGram) {
          if (data && data.pricePerGram) pricePerGram = +data.pricePerGram;
          else if (data && data.price && typeof data.price === 'number') pricePerGram = +data.price;
          else if (data && data.rates && data.rates.XAU) {
            pricePerGram = (+data.rates.XAU) / 31.1034768;
          }
        }

        if (pricePerGram) {
          console.log('‚úì Live rate fetched:', pricePerGram);
        }
        return pricePerGram;
      } catch (e) {
        console.warn('‚úó Live rate fetch failed:', e.message);
        return null;
      }
    }

    async function fetchLiveRateAndApply() {
      const pricePerGram = await fetchLiveRateOnce();
      if (!pricePerGram) {
        console.log('Using default rate: ‚Çπ' + basePrice24);
        return;
      }

      // Update basePrice24 with the fetched 24K rate
      basePrice24 = pricePerGram;
      console.log('Updated basePrice24 to:', basePrice24);
      
      // Update rate input based on current purity
      isUpdatingRate = true;
      const purity = +purityEl.value || 1;
      const adjustedRate = Math.round(basePrice24 * purity);
      rateInput.value = adjustedRate;
      isUpdatingRate = false;

      // Update subtitle with timestamp
      const subtitle = document.querySelector('.subtitle');
      if (subtitle) {
        const now = new Date();
        subtitle.innerText = `Live rate ‚Äî updated ${now.toLocaleTimeString()}`;
      }
      
      // Recalculate with new rate
      calculateGold();
    }

    // Initialize: try to fetch live rate first, then calculate
    (async () => {
      await fetchLiveRateAndApply();
      // If live rate failed, this will use default rate
      if (basePrice24 === 6000) {
        updateRateForPurity(); // Use default rate
      }
      // Set up periodic updates
      if (LIVE_RATE_URL) {
        setInterval(fetchLiveRateAndApply, RATE_FETCH_INTERVAL_MS);
      }
    })();
  </script>

  <script src="./Js/Index/entryFile.js" type="module"></script>

</body>

</html>